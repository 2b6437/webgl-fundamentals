<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/ja/webgl-2-textures.md. Do not edited directly -->
<!--
Copyright 2012, Gregg Tavares.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of Gregg Tavares. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta property="og:title" content="WebGLで複数のテクスチャを使う" />
<meta property="og:type" content="website" />
<meta property="og:image" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />
<meta property="og:description" content="WebGLアプリケーションで２つ以上のテクスチャeを利用する方法" />
<meta property="og:url" content="http://webglfundamentals.org/webgl/lessons/ja/webgl-2-textures.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="webglfundamentals.org" />
<meta name="twitter:title" content="WebGLで複数のテクスチャを使う" />
<meta name="twitter:url" content="http://webglfundamentals.org/webgl/lessons/ja/webgl-2-textures.html" />
<meta name="twitter:description" content="WebGLアプリケーションで２つ以上のテクスチャeを利用する方法" />
<meta name="twitter:image:src" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />


<title>WebGLで複数のテクスチャを使う</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css" type="text/css" />
</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-2-textures.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-2-textures.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-2-textures.html" selected>日本語</a>
    <option value="/webgl/lessons/pl/webgl-2-textures.html" >Polski</a>
    <option value="/webgl/lessons/ru/webgl-2-textures.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-2-textures.html" >简体中文</a>
</select>


    <a href="#toc">目次</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/ja/">WebGLFundamentals.org</a></h1>
</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGLで複数のテクスチャを使う</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>この記事は「<a href="webgl-image-processing.html">WebGLにおける画像処理</a>」の続きである。
画像処理の基本をまだ学んでいないなら「<a href="webgl-image-processing.html">WebGLにおける画像処理</a>」
を先に読んでおくことをお勧めする。</p>
<p>今回の講義では、「複数のテクスチャーを利用するにはどうしたらよいか？」という
疑問に答えようと思う。</p>
<p>簡単な答えではある。
「<a href="webgl-image-processing.html">WebGLにおける画像処理</a>」の連載を振り返って、
そのサンプルを元に、２枚の画像を利用するように改造すればよい。</p>
<p>改造するにあたって、まずは画像を２枚ロードするように書き換える必要がある。
実のところこれはWebGLの話題ではなくHTML5やJavaScriptプログラミングの話題であるが、
これに挑戦してみよう。</p>
<p>先の講義で述べた通り、HTMLでは画像のロードは非同期で行われる。
非同期であるため、ロード完了のタイミングに注意しないと問題が起こる可能性がある。
これに対処するには、２つの方法がある。
ひとつめは、「画像がない状態で描画コードを開始してしまって、
画像がロードされた時点で表示を更新する」という方法である。
この方法は別の機会に説明しようと思う。</p>
<p>ふたつめは、「描画を開始するのを保留しておいて、全ての画像がロードされてから描画を開始する」
という方法である。今回はこの方法で実装することにする。</p>
<p>まず、以前の講義で作ったサンプルの「１枚の画像をロードする部分」を切り出して、
関数として再定義しておこう。
「<code>Image</code>オブジェクトを生成」、「画像のURLをセット」、
「ロード完了時に実行されるコールバック関数を設定」、という手順になる。
特別なことはしていない。</p>
<pre><code>function loadImage(url, callback) {
  var image = new Image();
  image.src = url;
  image.onload = callback;
  return image;
}
</code></pre><p>ではこの<code>loadImage</code>を利用して、複数の画像に対応した関数<code>loadImages</code>を定義しよう。
<code>loadImages</code>は、「URLの配列を受け取って」、「画像の配列を生成」する。</p>
<p>ロードすべき画像の数は、URLの配列から得られる。
これを、<code>imagesToLoad</code>としている。
<code>loadImage</code>に渡すコールバック関数<code>onImageLoad</code>を定義する。
<code>onImageLoad</code>では、<code>imagesToLoad</code>をデクリメント(値を1減らす)し、
<code>imagesToLoad</code>の値が0になった時点、つまり画像が全てロードされた時点で
<code>loadImages</code>のコールバック関数に画像の配列を渡して呼び出す。</p>
<pre><code>function loadImages(urls, callback) {
  var images = [];
  var imagesToLoad = urls.length;

  // 各画像のロードが完了するたびに呼び出される関数
  var onImageLoad = function() {
    --imagesToLoad;
    // 全画像のロードが完了したら、引数で指定されたコールバック関数を呼ぶ。
    if (imagesToLoad == 0) {
      callback(images);
    }
  };

  for (var ii = 0; ii &lt; imagesToLoad; ++ii) {
    var image = loadImage(urls[ii], onImageLoad);
    images.push(image);
  }
}
</code></pre><p><code>loadImages</code>は次のようなコードで呼び出される。</p>
<pre><code>function main() {
  loadImages([
    &quot;resources/leaves.jpg&quot;,
    &quot;resources/star.jpg&quot;,
  ], render);
}
</code></pre><p>次はシェーダー側を複数テクスチャに対応する。
今回は２枚の画像をそれぞれ表示するのではなく、画素ひとつひとつを乗算するような処理にしておこう。</p>
<pre><code>&lt;script id=&quot;2d-fragment-shader&quot; type=&quot;x-shader/x-fragment&quot;&gt;
precision mediump float;

// ロードされたテクスチャ
uniform sampler2D u_image0;
uniform sampler2D u_image1;

// 頂点シェーダーから渡されたtexCoords(テクスチャ座標)
varying vec2 v_texCoord;

void main() {
   vec4 color0 = texture2D(u_image0, v_texCoord);
   vec4 color1 = texture2D(u_image1, v_texCoord);
   gl_FragColor = color0 * color1;
}
&lt;/script&gt;
</code></pre><p>WebGL textureオブジェクトを２つ、生成する。</p>
<pre><code>  // 「テクスチャー」を２つ生成する
  var textures = [];
  for (var ii = 0; ii &lt; 2; ++ii) {
    var texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, texture);

    // どんなサイズの画像でもレンダリングできるようにパラメータを設定する
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

    // テクスチャーに画像のデータをアップロードする
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, images[ii]);

    // テクスチャをテクスチャの配列に追加する。
    textures.push(texture);
  }
</code></pre><p>WebGLには「テクスチャへの参照の配列」のようなものがある。これは「テクスチャユニット」と呼ばれる。
シェーダーの各sampler変数が、それぞれ何番のテクスチャユニットを使用するか指定する。</p>
<pre><code>  // シェーダーで定義されているsampler変数のロケーションを取得する。
  var u_image0Location = gl.getUniformLocation(program, &quot;u_image0&quot;);
  var u_image1Location = gl.getUniformLocation(program, &quot;u_image1&quot;);

  ...

  // 各sampler変数が、どのテクスチャユニットに対応付けられるかセットする。
  gl.uniform1i(u_image0Location, 0);  // texture unit 0
  gl.uniform1i(u_image1Location, 1);  // texture unit 1
</code></pre><p>各テクスチャを、それぞれのテクスチャユニットにバインドする。</p>
<pre><code>  // 各テクスチャユニットが、どのテクスチャを使用するかセットする。
  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture(gl.TEXTURE_2D, textures[0]);
  gl.activeTexture(gl.TEXTURE1);
  gl.bindTexture(gl.TEXTURE_2D, textures[1]);
</code></pre><p>今回利用する画像は以下の２つである。</p>
<p><style>.glocal-center { text-align: center; }
.glocal-center-content { margin-left: auto; margin-right: auto; }</style></p>
<div class="glocal-center"><table class="glocal-center-content"><tr>
<td><img src="../../resources/leaves.jpg" />
<img src="../../resources/star.jpg" /></td>
</tr></table></div>

<p>今回のプログラムの実行結果、つまり「２枚の画像をロード」して「乗算」した結果はこのようになる。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2-textures.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2-textures.html" target="_blank">クリックして別のウインドウを開く</a>
</div>

</p>
<p>「テクスチャユニット」の扱いについて、２点ほど補足しておこう。</p>
<p>１点目は、「アクティブテクスチャユニット」についてである。
テクスチャ関連のWebGL APIは全て「アクティブテクスチャユニット」に対して機能する。
「アクティブテクスチャユニット」とはグローバル変数であり、
操作対象がどのテクスチャユニットであるかを示すインデックスである。
各テクスチャユニットにはそれぞれ、「TEXTURE_2D」と「TEXTURE_CUBE_MAP」という
２つのターゲットがある。
テクスチャ関連の関数は、現在のアクティブテクスチャユニットの指定されたターゲット
に対して操作を行う。</p>
<p>喩えとして、「WebGLの仕組みをJavaScriptで表現する」としたら
こんな感じのコードになる。</p>
<pre><code>var getContext = function() {
  var textureUnits = [
    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },
    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },
    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },
    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },
    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },
    ...
  ];
  var activeTextureUnit = 0;

  var activeTexture = function(unit) {
    // テクスチャユニット番号のenum値を、0～の整数indexに変換する。
    var index = unit - gl.TEXTURE0;
    // WebGL内部のグローバル変数である「アクティブテクスチャユニット」をセット
    activeTextureUnit = index;
  };

  var bindTexture = function(target, texture) {
    // 現在のアクティブテクスチャユニットの現在のターゲットに、textureをセットする。
    textureUnits[activeTextureUnit][target] = texture;
  };

  var texImage2D = function(target, ... args ...) {
    // texImage2Dは、現在のアクティブテクスチャユニットのtextureに対して、操作を行う。
    var texture = textureUnits[activeTextureUnit][target];
    texture.image2D(...args...);
  };

  // getContextの返り値として、WebGL APIを返す
  return {
    activeTexture: activeTexture,
    bindTexture: bindTexture,
    texImage2D: texImage2D,
  }
};
</code></pre><p>２点目は、テクスチャユニットの指定方法が二種類あるという点である。
シェーダーではテクスチャユニットの指定の際、「テクスチャユニットの番号」を使う。
これを意識していれば、以下の２行の意味は明らかだろう。</p>
<pre><code>  gl.uniform1i(u_image0Location, 0);  // texture unit 0
  gl.uniform1i(u_image1Location, 1);  // texture unit 1
</code></pre><p>uniformのセットを行なう際は、このように「0から始まる整数値」で指定するのに対し、
gl.activeTextureではgl.TEXTURE0やgl.TEXTURE1といった「定義済みの定数」
で指定する。この点には注意が必要である。</p>
<pre><code>  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture(gl.TEXTURE_2D, textures[0]);
  gl.activeTexture(gl.TEXTURE1);
  gl.bindTexture(gl.TEXTURE_2D, textures[1]);
</code></pre><p>幸いこれらの定数は連番の整数値として定義されているので、下のような書き方ができる。</p>
<pre><code>  gl.activeTexture(gl.TEXTURE0 + 0);
  gl.bindTexture(gl.TEXTURE_2D, textures[0]);
  gl.activeTexture(gl.TEXTURE0 + 1);
  gl.bindTexture(gl.TEXTURE_2D, textures[1]);
</code></pre><p>こんな書き方もできる。</p>
<pre><code>  for (var ii = 0; ii &lt; 2; ++ii) {
    gl.activeTexture(gl.TEXTURE0 + ii);
    gl.bindTexture(gl.TEXTURE_2D, textures[ii]);
  }
</code></pre><p>以上、この小さなヒントが「WebGLにおいて１回のドローコールで
複数テクスチャを使う方法」について、理解の助けとなることを願う。</p>

    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-2-textures.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-2-textures.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-2-textures.html" selected>日本語</a>
    <option value="/webgl/lessons/pl/webgl-2-textures.html" >Polski</a>
    <option value="/webgl/lessons/ru/webgl-2-textures.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-2-textures.html" >简体中文</a>
</select>


        <div id="toc">
          <ul>
  <li>基本</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-fundamentals.html">WebGLの基本</a></li>
    <li><a href="/webgl/lessons/ja/webgl-how-it-works.html">WebGLの仕組み</a></li>
    <li><a href="/webgl/lessons/ja/webgl-shaders-and-glsl.html">WebGLのシェーダーとGLSL</a></li>
  </ul>
  <li>画像処理</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-image-processing.html">WebGLにおける画像処理</a></li>
    <li><a href="/webgl/lessons/ja/webgl-image-processing-continued.html">WebGLにおける画像処理。続き</a></li>
  </ul>
  <li>2Dでの移動、回転、拡大縮小、行列計算</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-2d-translation.html">WebGL - 二次元での移動</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-rotation.html">WebGL - 二次元での回転</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-scale.html">WebGL - 二次元での拡大縮小</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-matrices.html">WebGL - 二次元での行列数学</a></li>
  </ul>
  <li>3D</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-orthographic.html">WebGL三次元の正投影</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-perspective.html">WebGL三次元透視投影</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-camera.html">WebGL三次元のカメラ</a></li>
  </ul>
  <li>Lighting</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-lighting-directional.html">WebGL三次元指向性光源</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-lighting-point.html">WebGL三次元点光源</a></li>
  </ul>
  <li>Structure and Organization</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-less-code-more-fun.html">WebGL - Less Code, More Fun(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-drawing-multiple-things.html">WebGL - Drawing Multiple Things(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-scene-graph.html">WebGL - Scene Graphs(英語)</a></li>
  </ul>
  <li>Textures</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-textures.html">WebGL 3D - Textures(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-data-textures.html">WebGL Data Textures(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2-textures.html">WebGLで複数のテクスチャを使う</a></li>
    <li><a href="/webgl/lessons/ja/webgl-cors-permission.html">WebGL - Cross Origin Images(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html">WebGL 3D - Perspective Correct Texture Mapping(英語)</a></li>
  </ul>
  <li>Rendering To A Texture</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-render-to-texture.html">WebGL Render to Texture</a></li>
  </ul>
  <li>Techniques</li>
  <ul>
    <li>2D</li>
    <ul>
      <li><a href="/webgl/lessons/ja/webgl-2d-drawimage.html">WebGL 2D - DrawImage(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-2d-matrix-stack.html">WebGL 2D - Matrix Stack(英語)</a>
    </ul>
    <li>Text</li>
    <ul>
      <li><a href="/webgl/lessons/ja/webgl-text-html.html">WebGL Text - HTML(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-canvas2d.html">WebGL Text - Canvas 2D(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-texture.html">WebGL Text - Using a Texture(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-glyphs.html">WebGL Text - Using a Glyph Texture(英語)</a>
    </ul>
  </ul>
  <li>その他のトピック</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-setup-and-installation.html">WebGLの開発環境</a></li>
    <li><a href="/webgl/lessons/ja/webgl-boilerplate.html">WebGLのひな型コード</a></li>
    <li><a href="/webgl/lessons/ja/webgl-resizing-the-canvas.html">WebGLとcanvasのリサイズ</a></li>
    <li><a href="/webgl/lessons/ja/webgl-animation.html">WebGL - Animation(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-and-alpha.html">WebGL and Alpha(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-vs-3d-library.html">WebGL - 2D vs 3D libraries(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-anti-patterns.html">WebGL - Anti-Patterns(英語)</a></li>
  </ul>
</ul>
<ul>
  <li><a href="/docs/">Helper API Docs(英語)</a></li>
  <li><a href="http://twgljs.org">TWGL, A tiny WebGL helper library</a></li>
  <li><a href="https://github.com/greggman/webgl-fundamentals">github</a></li>
</ul>

        </div>
    </div>
    <div class="lesson-comments">
        <div>質問? <a href="http://stackoverflow.com/questions/tagged/webgl">stackoverflowで質問(英語)</a>.</div>
        <div>問題点/バグ? <a href="http://github.com/greggman/webgl-fundamentals/issues">githubでissueを作成</a>.</div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGLで複数のテクスチャを使う';
            var disqus_title = 'WebGLで複数のテクスチャを使う';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js"></script>
<script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');

</script>


</html>



