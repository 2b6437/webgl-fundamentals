<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/ja/webgl-image-processing-continued.md. Do not edited directly -->
<!--
Copyright 2012, Gregg Tavares.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of Gregg Tavares. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta property="og:title" content="WebGLにおける画像処理。続き" />
<meta property="og:type" content="website" />
<meta property="og:image" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />
<meta property="og:description" content="WebGLで複数の画像加工処理をするには" />
<meta property="og:url" content="http://webglfundamentals.org//webgl/lessons/ja/webgl-image-processing-continued.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="webglfundamentals.org" />
<meta name="twitter:title" content="WebGLにおける画像処理。続き" />
<meta name="twitter:url" content="http://webglfundamentals.org//webgl/lessons/ja/webgl-image-processing-continued.html" />
<meta name="twitter:description" content="WebGLで複数の画像加工処理をするには" />
<meta name="twitter:image:src" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />


<title>WebGLにおける画像処理。続き</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css" type="text/css" />
</head>
<body>
<div class="webgl_navbar">
  <div>
    <div class="language">
    <a href="/webgl/lessons/webgl-image-processing-continued.html">English</a>
    <a href="/webgl/lessons/fr/webgl-image-processing-continued.html">Français</a>
    <a href="/webgl/lessons/ja/webgl-image-processing-continued.html">日本語</a>
    <a href="/webgl/lessons/pl/webgl-image-processing-continued.html">Polski</a>
    <a href="/webgl/lessons/ru/webgl-image-processing-continued.html">Русский</a>
    <a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">简体中文</a>
</div>


    <a href="#toc">目次</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/ja/">WebGLFundamentals.org</a></h1>
</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGLにおける画像処理。続き</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>この記事は、「<a href="webgl-image-processing.html">WebGLにおける画像処理</a>」の続きです。
「<a href="webgl-image-processing.html">WebGLにおける画像処理</a>」から読み始めることをお勧めします。</p>
<p>画像処理の次の問題は「複数の画像処理を行うにはどうしたら良いか？」です。</p>
<p>さて、画像処理をするシェーダーを毎回生成することはできます。
専用のUI画面を用意して、
使いたい画像処理エフェクトをユーザーが選択すると、必要な処理を行う
カスタムメードのシェーダーがそのたびに生成される、といった仕組みです。
すべてが解決、というわけではありませんが、この方法は
<a href="http://www.youtube.com/watch?v=cQUn0Zeh-0Q">リアルタイムグラフィクスのためのエフェクト作成で実際に使われていた例</a>
もあります。</p>
<p>より柔軟なのやり方は、２枚のテクスチャを交互に使って、次々に別のエフェクトを
かけていく方法です。</p>
<blockquote><pre>
元画像         -&gt; [ぼかし(Blur)]          -&gt; Texture 1
Texture 1      -&gt; [シャープ(Sharpen)]     -&gt; Texture 2
Texture 2      -&gt; [輪郭検出(Edge Detect)] -&gt; Texture 1
Texture 1      -&gt; [ぼかし(Blur)]          -&gt; Texture 2
Texture 2      -&gt; [Normal]                -&gt; Canvas</pre></blockquote>

<p>これを実現するためには「フレームバッファ」を使う必要があります。
WebGLやOpenGLのフレームバッファは、フレームバッファという呼び名が
付けられていますが、実際にはバッファではなくステータスの集合(＝添付データのリスト)
に過ぎません。呼び名の良し悪しはともかく、フレームバッファにテクスチャを
添付することで、そのテクスチャに対して描画することが可能になります。</p>
<p>では最初に、<a href="webgl-image-processing.html">以前書いたテクスチャ生成コード</a>を
関数として再定義しましょう。</p>
<pre><code>  function createAndSetupTexture(gl) {
    var texture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, texture);

    // どんなサイズの画像でもレンダリングできるように設定して、
    // ピクセル単位で操作できるようにする。
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

    return texture;
  }

  // テクスチャを生成し、画像を入れる。
  var originalImageTexture = createAndSetupTexture(gl);
  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
</code></pre><p>この関数を使って２つのテクスチャを作成、２つのフレームバッファにアタッチ(添付)します。</p>
<pre><code>  // テクスチャを２つ生成して、フレームバッファにアタッチする。
  var textures = [];
  var framebuffers = [];
  for (var ii = 0; ii &lt; 2; ++ii) {
    var texture = createAndSetupTexture(gl);
    textures.push(texture);

    // 画像と同じサイズでテクスチャを生成する
    gl.texImage2D(
        gl.TEXTURE_2D, 0, gl.RGBA, image.width, image.height, 0,
        gl.RGBA, gl.UNSIGNED_BYTE, null);

    // フレームバッファを生成する
    var fbo = gl.createFramebuffer();
    framebuffers.push(fbo);
    gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);

    // そこにテクスチャをアタッチする。
    gl.framebufferTexture2D(
        gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
  }
</code></pre><p>様々なエフェクトを「畳み込み行列」として定義して、適用するエフェクトのリストを用意します。</p>
<pre><code>  // 「畳み込み行列(convolution kernels)」を定義する
  var kernels = {
    normal: [
      0, 0, 0,
      0, 1, 0,
      0, 0, 0
    ],
    gaussianBlur: [
      0.045, 0.122, 0.045,
      0.122, 0.332, 0.122,
      0.045, 0.122, 0.045
    ],
    unsharpen: [
      -1, -1, -1,
      -1,  9, -1,
      -1, -1, -1
    ],
    emboss: [
       -2, -1,  0,
       -1,  1,  1,
        0,  1,  2
    ]
  };

  // 適用するエフェクトのリスト。
  var effectsToApply = [
    &quot;gaussianBlur&quot;,
    &quot;emboss&quot;,
    &quot;gaussianBlur&quot;,
    &quot;unsharpen&quot;
  ];
</code></pre><p>最後に、２つのテクスチャを交互に使って各エフェクトを次々にかけていきます。</p>
<pre><code>  // 元画像から開始
  gl.bindTexture(gl.TEXTURE_2D, originalImageTexture);

  // テクスチャに書き込む時点では画像の上下をひっくり返さない
  gl.uniform1f(flipYLocation, 1);

  // このループでエフェクトをかけて行く。
  for (var ii = 0; ii &lt; effectsToApply.length; ++ii) {
    // フレームバッファのひとつを書き込み先として設定する。
    setFramebuffer(framebuffers[ii % 2], image.width, image.height);

    drawWithKernel(effectsToApply[ii]);

    // 次の書き込みの際は、いま書き込んだテクスチャを使う。
    gl.bindTexture(gl.TEXTURE_2D, textures[ii % 2]);
  }

  // 最終的結果をcanvasへ書き込む。
  gl.uniform1f(flipYLocation, -1);  // 座標系の上下はここでひっくり返す
  setFramebuffer(null, canvas.width, canvas.height);
  drawWithKernel(&quot;normal&quot;);

  function setFramebuffer(fbo, width, height) {
    // このfboを書き込み先フレームバッファとして設定する。
    gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);

    // シェーダーにフレームバッファの解像度の情報を伝える。
    gl.uniform2f(resolutionLocation, width, height);

    // フレームバッファで必要となるため、WebGLにビューポートの設定を伝える。
    gl.viewport(0, 0, width, height);
  }

  function drawWithKernel(name) {
    // 今回適用するエフェクトの畳み込み行列をセット
    gl.uniform1fv(kernelLocation, kernels[name]);

    // 長方形を描画する
    gl.drawArrays(gl.TRIANGLES, 0, 6);
  }
</code></pre><p>下の画面は、少々改造して柔軟なUIを付け足したバージョンです。
適用したいエフェクトにはチェックを入れます。
エフェクトの適用順はドラッグで変更できます。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-image-processing.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-image-processing.html" target="_blank">クリックして別のウインドウを開く</a>
</div>

</p>
<p>まだ説明していないことがいくつかあります。</p>
<p><code>gl.bindFramebuffer</code>メソッドを引数<code>null</code>で呼びだして
いるのは、フレームバッファではなくcanvasに書き込む、という意味です。</p>
<p>この時、WebGLは<a href="webgl-fundamentals.html">クリッピング空間</a>からピクセルに変換
しなくてはなりません。この時WebGLが基準とするのが<code>gl.viewport</code>です。
レンダリングに使っているフレームバッファはcanvasとは異なるサイズなので、
フレームバッファのテクスチャにレンダリングする時点で適切なビューポートを
セットしておいて、canvasにレンダリングするタイミングで改めて設定する必要があります。</p>
<p>最後に、<a href="webgl-fundamentals.html">元のサンプル</a>では、Y座標を
ひっくり返していました。これは、WebGLでは座標0,0がcanvasの左下隅となっていて、
左上隅を基準とする従来の座標系とは違うためでした。
この操作は、フレームバッファに書き込む時点では不要です。フレームバッファは
表示されることがないため、どちらが上か下かといった話とは無関係だからです。
フレームバッファの中でピクセル0,0が、エフェクトの計算上の0,0と一致している
ことだけ意識していればよいのです。このため、上下をひっくり返すかどうかは、
シェーダーの入力の一つ(u_flipY)を使って決められるようにしています。</p>
<pre><code>&amp;lt;script id=&quot;2d-vertex-shader&quot; type=&quot;x-shader/x-vertex&quot;&amp;gt;
...
uniform float u_flipY;
...

void main() {
   ...

   gl_Position = vec4(clipSpace * vec2(1, u_flipY), 0, 1);

   ...
}
&amp;lt;/script&amp;gt;
</code></pre><p>そして、これをレンダリングの時点でセットしています。</p>
<pre><code>  ...

  var flipYLocation = gl.getUniformLocation(program, &quot;u_flipY&quot;);

  ...

  // ひっくり返さない
  gl.uniform1f(flipYLocation, 1);

  ...

  // ひっくり返す
  gl.uniform1f(flipYLocation, -1);
</code></pre><p>今回はプログラムを単純にするため、GLSLプログラムを１つだけ使って、
複数のエフェクトを実現してみました。本格的に画像処理をやろうとする場合は、
GLSLプログラムを複数用意することになると思います。色相、彩度、輝度を
調整するエフェクト用プログラム、明度、コントラストのエフェクト用プログラム、
逆転させたり、量を調整したりするエフェクト用プログラム、といった具合です。
GLSLプログラムを切り替えたり、パラメータを更新したりするため、
コードを書き換える必要があるでしょう。実際にそういうサンプルプログラムを
書くことも考えたのですが、そういったことは読者の練習のために残しておくことに
しました。複数のGLSLプログラムやそのパラメータを扱うのは、なかなか大変で、
プログラムが混沌とするのを抑えるためのリファクタリング作業は大掛かりなもの
になると思います。</p>
<p>このプログラムや、この後登場するプログラムが、読者にとってとっつきやすい
ものであれば、と思います。二次元処理から始めることが、WebGLの理解の助けに
なればと思います。時間ができたら、三次元表示のやり方や、その裏でWebGLが
本当は何をやっているのかといった詳細について、
<a href="webgl-2d-translation.html">新しい記事</a>を書いてみようと思います。
次の記事は<a href="webgl-2-textures.html">２つ以上のテクスチャを使う方法</a>の記事に
なる予定です。</p>

    </div>
    <div class="lesson-sidebar">
        <div class="language">
    <a href="/webgl/lessons/webgl-image-processing-continued.html">English</a>
    <a href="/webgl/lessons/fr/webgl-image-processing-continued.html">Français</a>
    <a href="/webgl/lessons/ja/webgl-image-processing-continued.html">日本語</a>
    <a href="/webgl/lessons/pl/webgl-image-processing-continued.html">Polski</a>
    <a href="/webgl/lessons/ru/webgl-image-processing-continued.html">Русский</a>
    <a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">简体中文</a>
</div>


        <div id="toc">
          <ul>
  <li>基本</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-fundamentals.html">WebGLの基本</a></li>
    <li><a href="/webgl/lessons/ja/webgl-how-it-works.html">WebGLの仕組み</a></li>
    <li><a href="/webgl/lessons/ja/webgl-shaders-and-glsl.html">WebGL Shaders and GLSL(英語)</a></li>
  </ul>
  <li>画像処理</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-image-processing.html">WebGLにおける画像処理</a></li>
    <li><a href="/webgl/lessons/ja/webgl-image-processing-continued.html">WebGLにおける画像処理。続き</a></li>
  </ul>
  <li>2Dでの移動、回転、拡大縮小、行列計算</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-2d-translation.html">WebGL - 二次元での移動</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-rotation.html">WebGL - 二次元での回転</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-scale.html">WebGL - 二次元での拡大縮小</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-matrices.html">WebGL - 二次元での行列数学</a></li>
  </ul>
  <li>3D</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-orthographic.html">WebGL三次元の正投影</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-perspective.html">WebGL三次元透視投影</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-camera.html">WebGL三次元のカメラ</a></li>
  </ul>
  <li>Lighting</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-lighting-directional.html">WebGL 3D - Directional Lighting(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-lighting-point.html">WebGL 3D - Point Lighting(英語)</a></li>
  </ul>
  <li>Structure and Organization</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-less-code-more-fun.html">WebGL - Less Code, More Fun(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-drawing-multiple-things.html">WebGL - Drawing Multiple Things(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-scene-graph.html">WebGL - Scene Graphs(英語)</a></li>
  </ul>
  <li>Textures</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-3d-textures.html">WebGL 3D - Textures(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-data-textures.html">WebGL Data Textures(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2-textures.html">WebGL - Using 2 or More Textures(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-cors-permission.html">WebGL - Cross Origin Images(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html">WebGL 3D - Perspective Correct Texture Mapping(英語)</a></li>
  </ul>
  <li>Rendering To A Texture</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-render-to-texture.html">WebGL Render to Texture</a></li>
  </ul>
  <li>Techniques</li>
  <ul>
    <li>2D</li>
    <ul>
      <li><a href="/webgl/lessons/ja/webgl-2d-drawimage.html">WebGL 2D - DrawImage(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-2d-matrix-stack.html">WebGL 2D - Matrix Stack(英語)</a>
    </ul>
    <li>Text</li>
    <ul>
      <li><a href="/webgl/lessons/ja/webgl-text-html.html">WebGL Text - HTML(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-canvas2d.html">WebGL Text - Canvas 2D(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-texture.html">WebGL Text - Using a Texture(英語)</a>
      <li><a href="/webgl/lessons/ja/webgl-text-glyphs.html">WebGL Text - Using a Glyph Texture(英語)</a>
    </ul>
  </ul>
  <li>その他のトピック</li>
  <ul>
    <li><a href="/webgl/lessons/ja/webgl-setup-and-installation.html">WebGLの開発環境</a></li>
    <li><a href="/webgl/lessons/ja/webgl-boilerplate.html">WebGLのひな型コード</a></li>
    <li><a href="/webgl/lessons/ja/webgl-resizing-the-canvas.html">WebGLとcanvasのリサイズ</a></li>
    <li><a href="/webgl/lessons/ja/webgl-animation.html">WebGL - Animation(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-and-alpha.html">WebGL and Alpha(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-2d-vs-3d-library.html">WebGL - 2D vs 3D libraries(英語)</a></li>
    <li><a href="/webgl/lessons/ja/webgl-anti-patterns.html">WebGL - Anti-Patterns(英語)</a></li>
  </ul>
</ul>
<ul>
  <li><a href="/docs/">Helper API Docs(英語)</a></li>
  <li><a href="http://twgljs.org">TWGL, A tiny WebGL helper library</a></li>
  <li><a href="https://github.com/greggman/webgl-fundamentals">github</a></li>
</ul>

        </div>
    </div>
    <div class="lesson-comments">
        <div>質問? <a href="http://stackoverflow.com/questions/tagged/webgl">stackoverflowで質問(英語)</a>.</div>
        <div>問題点/バグ? <a href="http://github.com/greggman/webgl-fundamentals/issues">githubでissueを作成</a>.</div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGLにおける画像処理。続き';
            var disqus_title = 'WebGLにおける画像処理。続き';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js"></script>
<script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');

</script>


</html>



