<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/ru/webgl-animation.md. Do not edited directly -->
<!--
Copyright 2012, Gregg Tavares.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

    * Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above
copyright notice, this list of conditions and the following disclaimer
in the documentation and/or other materials provided with the
distribution.
    * Neither the name of Gregg Tavares. nor the names of his
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta property="og:title" content="WebGL - Анимация" />
<meta property="og:type" content="website" />
<meta property="og:image" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />
<meta property="og:description" content="Анимация в WebGL" />
<meta property="og:url" content="http://webglfundamentals.org//webgl/lessons/ru/webgl-animation.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="webglfundamentals.org" />
<meta name="twitter:title" content="WebGL - Анимация" />
<meta name="twitter:url" content="http://webglfundamentals.org//webgl/lessons/ru/webgl-animation.html" />
<meta name="twitter:description" content="Анимация в WebGL" />
<meta name="twitter:image:src" content="http://webglfundamentals.org/webgl/lessons/resources/webglfundamentals.jpg" />


<title>WebGL - Анимация</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/resources/base.css" type="text/css" />
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css" type="text/css" />
</head>
<body>
<div class="webgl_header">
  <h1><a href="/">WebGLFundamentals.org</a></h1>
</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL - Анимация</h1>
  </div>
  <div class="row">
    <div class="col-sm-8 lesson-main">
      <p>Эта статья продолжает серию статей о WebGL. Первая была об
<a href="webgl-fundamentals.html">основах</a>, а в предыдущей мы рассмотрели
<a href="webgl-3d-camera.html">камеры</a>. Если вы их ещё не читали, то
рекомендую сначала ознакомиться с ними.</p>
<p>Как создать анимацию в WebGL?</p>
<p>На самом деле анимация - это больше работа JavaScript, нежели WebGL.
Для анимации необходимо менять что-либо в JavaScript с течением времени
и при этом постоянно вызывать отрисовку.</p>
<p>Мы можем взять один из наших предыдущих примеров и сделать анимацию:</p>
<pre><code>*var fieldOfViewRadians = degToRad(60);
*var rotationSpeed = 1.2;

*requestAnimationFrame(drawScene);

// отрисовка сцены
function drawScene() {
*  // каждый кадр немного увеличивается поворот
*  rotation[1] += rotationSpeed / 60.0;

  ...
*  // в следующем кадре снова вызываем drawScene
*  requestAnimationFrame(drawScene);
}
</code></pre><p>И анимация готова:</p>
<p><div>
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-animation-not-frame-rate-independent.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/..%2Fwebgl-animation-not-frame-rate-independent.html" target="_blank">нажмите здесь, чтобы открыть в отдельном окне</a>
</div>

</p>
<p>Однако, здесь есть одна неявная проблема. В коде выше содержится
<code>rotationSpeed / 60.0</code>. Мы делим на 60.0, потому что предполагаем, что браузер
вызовет requestAnimationFrame 60 раз за секунду, что является близким к правде.</p>
<p>Однако, это не верное предположение. Возможно, у пользователя медленное
устройство вроде старого смартфона. Или, возможно, у пользователя в фоне запущена
очень ресурсоёмкая программа. Есть множество причин, по которым браузер может не
отображать 60 кадров в секунду. Возможно, наступил 2020 год и все устройства
работают на частоте 240 кадров в секунду. А возможно, пользователь большой фанат
игр и у него ЭЛТ-монитор с частотой 90 кадров в секунду.</p>
<p>Проблема наглядно продемонстрирована на следующем примере:</p>
<p><div>
  <iframe class="webgl_example " style="width: 400px; height: 300px;" src="/webgl/lessons/../webgl-animation-frame-rate-issues.html"></iframe>
</div>

</p>
<p>В примере выше мы хотели бы поворачивать все буквы &#39;F&#39; с одной скоростью. Буква
&#39;F&#39; посередине работает на полной скорости и её частота кадров ни от чего не
зависит. Буквы слева и справа симулируют, будто браузер работает на 1/8 от полной
мощности компьютера. Буква слева <strong>ЗАВИСИМА</strong> от частоты кадров. Буква справа
<strong>НЕЗАВИСИМА</strong> от частоты кадров</p>
<p>Заметьте, что буква слева не принимает во внимание, что частота кадров может быть
низкой, и не успевает поворачиваться. Буква справа, даже несмотря на работу в
режиме 1/8 доли от частоты кадров, успевает вращаться и не отстаёт от средней
буквы, вращающейся на полной скорости.</p>
<p>Для того, чтобы сделать анимацию независимой от кадров, необходимо вычислять,
сколько времени проходит между кадрами, и использовать это для определения
времени анимации текущего кадра.</p>
<p>Для начала нам нужно получить время. К счастью, <code>requestAnimationFrame</code> при своём
вызове передаёт нам время, прошедшее с загрузки страницы.</p>
<p>Лично мне кажется, что проще всего работать со временем в секундах, но так как
<code>requestAnimationFrame</code> передаёт время в миллисекундах (тысяча секунд), нам нужно
умножить на 0.001, чтобы получить секунды.</p>
<p>После этого мы сможем получить разницу во времени.</p>
<pre><code>*var then = 0;

requestAnimationFrame(drawScene);

// отрисовка сцены
*function drawScene(now) {
*  // получаем время в секундах
*  now *= 0.001;
*  // вычитаем предыдущее значение времени от текущего
*  var deltaTime = now - then;
*  // запоминаем текущее время для следующего кадра
*  then = now;

   ...
</code></pre><p>Когда у нас есть <code>deltaTime</code> в секундах, наши расчёты будут строиться на том,
сколько раз в секунду мы хотим выполнять что-либо. В нашем случае значение
<code>rotationSpeed</code> равно 1.2, то есть мы хотим выполнять поворот на 1.2 радиана
в секунду. Это примерно 1/5 поворота или, другими словами, нам необходимо 5
секунд для полного поворота независимо от частоты кадров.</p>
<pre><code>*    rotation[1] += rotationSpeed * deltaTime;
</code></pre><p>Вот рабочий пример.</p>
<p><div>
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-animation.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/..%2Fwebgl-animation.html" target="_blank">нажмите здесь, чтобы открыть в отдельном окне</a>
</div>

</p>
<p>Вероятно, вы не заметите разницы с примером в верху страницы, если только
у вас не медленный компьютер. Но если не учитывать частоту кадров, у
некоторых ваших пользователей картина может сильно отличаться от той,
которую вы планировали.</p>
<p>Далее рассмотрим <a href="webgl-3d-textures.html">работу с текстурами</a>.</p>
<div class="webgl_bottombar">
<h3>Не используйте функции setInterval и setTimeout!</h3>
<p>Если в прошлом вам приходилось создавать анимацию в JavaScript, возможно, вы
использовали либо <code>setInterval</code>, либо <code>setTimeout</code> для
вызова функции отрисовки.
</p><p>
Существует две проблемы, связанные с использованием функций <code>setInterval</code>
и <code>setTimeout</code> для анимации. Первая заключается в том, что обе этих функции
никак не привязаны к механизму отрисовки браузера. Они не синхронизованы со временем,
когда браузер собирается отрисовать новый кадр, и поэтому могут потерять синхронизацию
с устройством пользователя. Если вы используете <code>setInterval</code> или
<code>setTimeout</code> и предполагаете, что будет 60 кадров в секунду, а компьютер
пользователя работает с другой частотой кадров, то вы потеряете синхронизацию с
компьютером пользователя.
</p><p>
Другой проблемой является то, что браузер понятия не имеет, почему вы используете
<code>setInterval</code> или <code>setTimeout</code>. Поэтому даже когда страницу
не видно (например, если вкладка браузера не активна), браузер по-прежнему будет
выполнять ваш код. Возможно, вы используете <code>setTimeout</code> и <code>setInterval</code>
для проверки новой почты или твитов. Браузер никак не сможет догадаться. Если вы
каждые несколько секунд проверяете письма, то всё замечательно, но как насчёт
отрисовки 1000 объектов в WebGL? Вы в буквальном смысле будете вести DOS-атаку
на компьютер пользователя через отрисовку в закрытой вкладке объектов, которые
пользователь даже увидеть не может.
</p><p>
<code>requestAnimationFrame</code> решает обе эти проблемы. Функция вызывается в
нужное время, чтобы ваша анимация была синхронизована с экраном, и только тогда,
когда вкладку браузера видно.
</p>
</div>

      <hr class="lesson-comment-sep" />
      <div class="lesson-comments">
        <div>Вопросы? <a href="http://stackoverflow.com/questions/tagged/webgl">Спросите на stackoverflow</a>.</div>
        <div>Нашли ошибку? <a href="http://github.com/greggman/webgl-fundamentals/issues">Создайте задачу на github</a>.</div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL - Анимация';
            var disqus_title = 'WebGL - Анимация';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div class="col-sm-3 col-sm-offset-1 lesson-sidebar">
        <select id="language">
</select>

        <ul>
  <li>Основы</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-fundamentals.html">Основы WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-how-it-works.html">Как работает WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-shaders-and-glsl.html">Шейдеры и GLSL в WebGL</a></li>
  </ul>
  <li>Обработка изображений</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-image-processing.html">Обработка изображений в WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-image-processing-continued.html">Продолжаем обработку изображений в WebGL</a></li>
  </ul>
  <li>Математика переноса, поворота и масштабирования в 2D</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-2d-translation.html">2D-перенос в WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-2d-rotation.html">2D-поворот в WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-2d-scale.html">2D-масштабирование в WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-2d-matrices.html">2D-матрицы в WebGL</a></li>
  </ul>
  <li>3D</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-3d-orthographic.html">WebGL 3D - Ортогональ</a></li>
    <li><a href="/webgl/lessons/ru/webgl-3d-perspective.html">WebGL 3D - Перспектива</a></li>
    <li><a href="/webgl/lessons/ru/webgl-3d-camera.html">WebGL 3D - Камеры</a></li>
  </ul>
  <li>Освещение</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-3d-lighting-directional.html">WebGL 3D - Направленное освещение</a></li>
    <li><a href="/webgl/lessons/ru/webgl-3d-lighting-point.html">WebGL 3D - Точечное освещение</a></li>
  </ul>
  <li>Структура и устройство</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-less-code-more-fun.html">WebGL - Меньше кода, больше веселья</a></li>
    <li><a href="/webgl/lessons/ru/webgl-drawing-multiple-things.html">WebGL - Отрисовка нескольких объектов</a></li>
    <li><a href="/webgl/lessons/ru/webgl-scene-graph.html">WebGL - Графы сцены</a></li>
  </ul>
  <li>Геометрия</li>
  <ul>
    <li><a href="/webgl/lessons/webgl-3d-geometry-lathe.html">WebGL 3D - Создание модели (en)</a></li>
  </ul>
  <li>Текстуры</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-3d-textures.html">WebGL 3D - Текстуры</a></li>
    <li><a href="/webgl/lessons/ru/webgl-2-textures.html">WebGL - Использование 2 и более текстур</a></li>
    <li><a href="/webgl/lessons/ru/webgl-cors-permission.html">WebGL - Кросс-доменные изображения</a></li>
  </ul>
  <li>Приёмы</li>
  <ul>
    <li>2D</li>
    <ul>
      <li><a href="/webgl/lessons/ru/webgl-2d-drawimage.html">WebGL 2D - DrawImage</a>
      <li><a href="/webgl/lessons/ru/webgl-2d-matrix-stack.html">WebGL 2D - Стек матриц</a>
    </ul>
    <li>Текст</li>
    <ul>
      <li><a href="/webgl/lessons/ru/webgl-text-html.html">WebGL текст - HTML</a>
      <li><a href="/webgl/lessons/ru/webgl-text-canvas2d.html">WebGL текст - Canvas 2D</a>
      <li><a href="/webgl/lessons/ru/webgl-text-texture.html">WebGL текст - Используем текстуру</a>
      <li><a href="/webgl/lessons/ru/webgl-text-glyphs.html">WebGL текст - Используем глиф-текстуру</a>
    </ul>
  </ul>
  <li>Разное</li>
  <ul>
    <li><a href="/webgl/lessons/ru/webgl-setup-and-installation.html">WebGL Установка и настройка</a></li>
    <li><a href="/webgl/lessons/ru/webgl-boilerplate.html">Шаблон WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-resizing-the-canvas.html">Изменение размера Canvas в WebGL</a></li>
    <li><a href="/webgl/lessons/ru/webgl-animation.html">WebGL - Анимация</a></li>
    <li><a href="/webgl/lessons/ru/webgl-and-alpha.html">WebGL и прозрачность</a></li>
    <li><a href="/webgl/lessons/ru/webgl-2d-vs-3d-library.html">WebGL - 2D и 3D библиотеки</a></li>
    <li><a href="/webgl/lessons/ru/webgl-anti-patterns.html">WebGL - Антипаттерны</a></li>
  </ul>
</ul>
<ul>
  <li><a href="/docs/">Документация по вспомогательным функциям</a></li>
  <li><a href="http://twgljs.org">TWGL, лёгкая библиотека-помощник для WebGL</a></li>
  <li><a href="https://github.com/greggman/webgl-fundamentals">github</a></li>
</ul>

    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js"></script>
<script src="/langdb.js"></script>
<script src="/webgl/lessons/resources/languages.js"></script>
<script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');

</script>


</html>



